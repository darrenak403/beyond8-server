x-common-environment: &common-environment
  ASPNETCORE_ENVIRONMENT: Development
  ASPNETCORE_URLS: http://+:8080
  OTEL_EXPORTER_OTLP_ENDPOINT: http://aspire-dashboard:18889
  OTEL_EXPORTER_OTLP_HEADERS: x-otlp-api-key=${ASPIRE_DASHBOARD_OTLP_API_KEY}
  JwtBearer__SecretKey: ${JWT_BEARER_SECRET_KEY}
  JwtBearer__Issuer: https://beyond8.io.vn
  JwtBearer__Audience: https://beyond8.io.vn
  JwtBearer__ExpirationMinutes: 60
  JwtBearer__RefreshTokenExpirationDays: 7
  JwtBearer__ValidateIssuer: true
  JwtBearer__ValidateAudience: true
  JwtBearer__ValidateLifetime: true
  JwtBearer__ValidateIssuerSigningKey: true
  JwtBearer__ClockSkewSeconds: 0
  FrontendUrl: https://beyond8.io.vn

x-identity-service-environment: &identity-service-environment
  ConnectionStrings__identity-db: Host=postgres;Port=5432;Database=${IDENTITY_SERVICE_DATABASE};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}
  ConnectionStrings__redis-cache: redis:6379,password=${REDIS_PASSWORD}
  ConnectionStrings__rabbitmq: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672

x-integration-service-environment: &integration-service-environment
  ConnectionStrings__integration-db: Host=postgres;Port=5432;Database=${INTEGRATION_SERVICE_DATABASE};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}
  ConnectionStrings__redis-cache: redis:6379,password=${REDIS_PASSWORD}
  ConnectionStrings__rabbitmq: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
  AWS__S3__AccessKey: ${AWS_ACCESS_KEY}
  AWS__S3__SecretKey: ${AWS_SECRET_KEY}
  AWS__S3__Region: ${AWS_S3_REGION}
  AWS__S3__BucketName: ${AWS_BUCKET_NAME}
  AWS__S3__CloudFrontUrl: ${AWS_CLOUD_FRONT_URL}

  AiProvider: ${AI_PROVIDER}

  AWS__Bedrock__AccessKey: ${AWS_ACCESS_KEY}
  AWS__Bedrock__SecretKey: ${AWS_SECRET_KEY}
  AWS__Bedrock__Region: ${AWS_BEDROCK_REGION}
  AWS__Bedrock__DefaultModel: ${AWS_BEDROCK_DEFAULT_MODEL}
  AWS__Bedrock__MaxRetries: ${AWS_BEDROCK_MAX_RETRIES}
  AWS__Bedrock__TimeoutSeconds: ${AWS_BEDROCK_TIMEOUT_SECONDS}
  AWS__Bedrock__RequestsPerMinute: ${AWS_BEDROCK_REQUESTS_PER_MINUTE}
  AWS__Bedrock__RequestsPerDay: ${AWS_BEDROCK_REQUESTS_PER_DAY}
  AWS__Bedrock__MaxConcurrentRequests: ${AWS_BEDROCK_MAX_CONCURRENT_REQUESTS}
  AWS__Bedrock__DefaultParameters__MaxTokens: ${AWS_BEDROCK_DEFAULT_PARAMETERS_MAX_TOKENS}
  AWS__Bedrock__DefaultParameters__Temperature: ${AWS_BEDROCK_DEFAULT_PARAMETERS_TEMPERATURE}
  AWS__Bedrock__DefaultParameters__TopP: ${AWS_BEDROCK_DEFAULT_PARAMETERS_TOP_P}
  AWS__Bedrock__DefaultParameters__TopK: ${AWS_BEDROCK_DEFAULT_PARAMETERS_TOP_K}

  Gemini__ApiKey: ${GEMINI_API_KEY}
  Gemini__ApiEndpoint: https://generativelanguage.googleapis.com/v1beta
  Gemini__DefaultModel: ${GEMINI_DEFAULT_MODEL}
  Gemini__MaxRetries: ${GEMINI_MAX_RETRIES}
  Gemini__TimeoutSeconds: ${GEMINI_TIMEOUT_SECONDS}
  Gemini__RequestsPerMinute: ${GEMINI_REQUESTS_PER_MINUTE}
  Gemini__RequestsPerDay: ${GEMINI_REQUESTS_PER_DAY}
  Gemini__MaxConcurrentRequests: ${GEMINI_MAX_CONCURRENT_REQUESTS}
  Gemini__DefaultParameters__MaxTokens: ${GEMINI_DEFAULT_PARAMETERS_MAX_TOKENS}
  Gemini__DefaultParameters__Temperature: ${GEMINI_DEFAULT_PARAMETERS_TEMPERATURE}
  Gemini__DefaultParameters__TopP: ${GEMINI_DEFAULT_PARAMETERS_TOP_P}
  Gemini__DefaultParameters__TopK: ${GEMINI_DEFAULT_PARAMETERS_TOP_K}

  Email__Resend__ApiKey: ${RESEND_API_KEY}
  Email__Resend__FromEmail: ${RESEND_FROM_EMAIL}
  Email__Resend__FromName: ${RESEND_FROM_NAME}

  VnptEkyc__BaseUrl: ${VNPT_EKYC_BASE_URL}
  VnptEkyc__TimeoutSeconds: ${VNPT_EKYC_TIMEOUT_SECONDS}
  VnptEkyc__AccessToken: ${VNPT_EKYC_ACCESS_TOKEN}
  VnptEkyc__TokenKey: ${VNPT_EKYC_TOKEN_KEY}
  VnptEkyc__TokenId: ${VNPT_EKYC_TOKEN_ID}

services:
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:13
    container_name: aspire-dashboard
    environment:
      DASHBOARD__OTLP__AUTHMODE: ApiKey
      DASHBOARD__OTLP__PRIMARYAPIKEY: ${ASPIRE_DASHBOARD_OTLP_API_KEY}
      DASHBOARD__OTLP__ENDPOINT: http://+:18889
      ASPNETCORE_URLS: http://+:18888
      DASHBOARD__UNSECUREDALLOWEDANONYMOUSACCESS: true
    ports:
      - "${ASPIRE_DASHBOARD_UI_PORT:-18888}:18888"
      - "${ASPIRE_DASHBOARD_OTLP_PORT:-18889}:18889"
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:18888 || exit 1" ]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - beyond8-network
    restart: unless-stopped

  postgres:
    image: postgres:17-alpine
    container_name: beyond8-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - beyond8-network
    restart: unless-stopped

  redis:
    image: redis:7.4.0-alpine
    container_name: beyond8-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - beyond8-network
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:4.0.2-management-alpine
    container_name: beyond8-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_NODENAME=rabbit@rabbitmq
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - beyond8-network
    restart: unless-stopped

  gateway:
    image: nginx:latest
    container_name: beyond8-gateway
    ports:
      - "${GATEWAY_PORT:-8080}:80"
    volumes:
      - ./data/gateway/etc/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - beyond8-network
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - identity-service
      - integration-service

  identity-service:
    build:
      context: ..
      dockerfile: src/Services/Identity/Beyond8.Identity.Api/Dockerfile
    container_name: beyond8-identity-service
    ports:
      - "${IDENTITY_SERVICE_PORT:-8081}:8080"
    environment:
      <<: [ *common-environment, *identity-service-environment ]
    depends_on:
      - aspire-dashboard
      - postgres
      - redis
      - rabbitmq
    networks:
      - beyond8-network
    restart: unless-stopped

  integration-service:
    build:
      context: ..
      dockerfile: src/Services/Integration/Beyond8.Integration.Api/Dockerfile
    container_name: beyond8-integration-service
    ports:
      - "${INTEGRATION_SERVICE_PORT:-8082}:8080"
    environment:
      <<: [ *common-environment, *integration-service-environment ]
    depends_on:
      - aspire-dashboard
      - postgres
      - redis
      - rabbitmq
    networks:
      - beyond8-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  gateway_data:


networks:
  beyond8-network:
    driver: bridge
